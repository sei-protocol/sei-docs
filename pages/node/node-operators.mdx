# Sei Node Operations

This guide covers the detailed operational aspects of running a Sei node,
including configuration management, maintenance procedures, and best practices
for stable and performant operations.

## Configuration Management

### Directory Structure

The Sei node configuration is stored in `~/.sei/config/`:

```bash
~/.sei/config/
├── app.toml          # Application configuration (gas fees, API settings, pruning, etc.)
├── client.toml       # CLI and client-related settings
├── config.toml       # Core Tendermint settings (network, consensus, and RPC)
├── genesis.json      # Chain genesis file, defines initial state
├── node_key.json     # Unique node identity key for peer-to-peer (P2P) networking
└── priv_validator_key.json  # Validator private signing key (if running as a validator)
```

## Configuration Parameters

Understanding configuration parameters is essential for optimizing your node's
performance and security.
Any parameters not specifically mentioned here typically can be left to default values.

### App.toml Parameters

The app.toml file controls application-specific settings:

<details>
<summary>~/.sei/config/app.toml</summary>

```toml
# Minimum gas prices for transaction acceptance
minimum-gas-prices = "0.02usei"

[api]
# This is a requirement for the EVM RPC to respond to requests
enable = true
swagger = true
address = "tcp://0.0.0.0:1317"
max-open-connections = 1000

# State sync configuration
[state-sync]
snapshot-interval = 10000
snapshot-keep-recent = 2

# State store configuration
[state-store]
ss-enable = true
ss-backend = "pebbledb"
ss-keep-recent = 100000
ss-prune-interval = 600
```

</details>

### Config.toml Parameters

The config.toml file controls the core consensus engine and networking:

<details>
<summary>~/.sei/config/config.toml</summary>

```toml
# P2P Configuration
[p2p]
laddr = "tcp://0.0.0.0:26656"
external_address = ""               # do not use this field
seeds = ""                          # do not use this field
persistent_peers = ""               # do not set more thann a few known good nodes
upnp = false
max_num_inbound_peers = 100
max_num_outbound_peers = 100
allowed_pools = ""
max_packet_msg_payload_size = 10240
handshake_timeout = "20s"
dial_timeout = "3s"

# RPC Configuration
[rpc]
laddr = "tcp://0.0.0.0:26657"
cors_allowed_origins = []          # this allows you to handle CORS at the app or web-server level
cors_allowed_methods = ["HEAD", "GET", "POST"]
cors_allowed_headers = ["Origin", "Accept", "Content-Type", "X-Requested-With", "X-Server-Time"]
max_open_connections = 900
timeout_broadcast_tx_commit = "10s"

#######################################################
###          Mempool Configuration Options         ###
#######################################################
[mempool]

# Enable transaction gossiping to other nodes.
# If false, transactions remain local and are not broadcasted.
broadcast = true

# Maximum number of valid (non-pending) transactions allowed in the mempool.
# Once reached, new transactions are rejected or trigger evictions.
size = 5000

# Maximum total size (in bytes) of all valid transactions in the mempool.
# Transactions exceeding this combined limit are rejected.
max-txs-bytes = 10737418240  # 10 GiB

# Cache size for previously seen transactions to prevent redundant processing.
# Transactions in the cache are ignored if re-broadcasted.
cache-size = 100000

# If true, invalid transactions remain in the cache and cannot be retried later.
# If false, invalid transactions may be re-submitted if they become valid.
keep-invalid-txs-in-cache = true

# Maximum size (in bytes) allowed for a single transaction.
# Transactions exceeding this size are rejected.
max-tx-bytes = 2048576  # ~2 MB

# Maximum size of a batch of transactions sent to a peer.
# Currently unused due to an open issue.
max-batch-bytes = 0  # Unused

# Maximum time a valid transaction can stay in the mempool before expiring.
# Transactions exceeding this duration are removed.
# "0s" = no time-based expiration
ttl-duration = "3s"

# Maximum number of blocks a valid transaction can stay in the mempool before expiring.
# Transactions exceeding this block count are removed.
# 0 = no block-based expiration
ttl-num-blocks = 5

# Minimum number of valid (non-pending) transactions required before mempool
# notifications are triggered (e.g., for block proposal).
# 0 = notify immediately if transactions exist
tx-notify-threshold = 0

# Enables automatic blacklisting of peers that repeatedly send invalid transactions.
# Once a peer exceeds the failure threshold, it is evicted.
check-tx-error-blacklist-enabled = true

# Number of failed transactions allowed per peer before blacklisting.
# If set to 0, a single failure results in immediate blacklisting.
check-tx-error-threshold = 10

# Maximum number of pending transactions allowed in the mempool.
# Pending transactions are not yet valid but may become valid later.
pending-size = 5000

# Maximum total size (in bytes) of all pending transactions.
# Transactions exceeding this limit are rejected.
max-pending-txs-bytes = 1073741824  # 1 GiB

# Maximum time a pending transaction can stay in the mempool before expiring.
# Applies only to pending transactions, separate from valid transaction TTLs.
# "0s" = no time-based expiration for pending transactions
pending-ttl-duration = "3s"

# Maximum number of blocks a pending transaction can stay in the mempool before expiring.
# Transactions exceeding this block count are removed.
# 0 = no block-based expiration for pending transactions
pending-ttl-num-blocks = 5

```

</details>

## Database Management

### Database Types

Sei supports two database backends:

1. **SeiDB (Recommended)**

   - Optimized for performance and sync times
   - Reduces resource usage
   - Best for all nodes

2. **Legacy IAVL DB**
   - Standard Cosmos SDK database
   - More widely tested

### Sei-DB Configuration

```toml
[state-commit]
sc-enable = true
sc-async-commit-buffer = 100
sc-keep-recent = 1  # Keep only the most recent state for performance
sc-snapshot-interval = 10000  # Take state snapshots every 10,000 blocks

[state-store]
ss-enable = true
ss-backend = "pebbledb"  # Default, required
ss-async-write-buffer = 100
ss-keep-recent = 100000  # Keep last 100,000 blocks
ss-prune-interval = 600  # Cleanup interval for pruning
```

Setting very small [more frequent] pruning intervals may cause issues with automated
snapshotting in the event those events collide. Too large [less frequent]
pruning intervals means it will take a longer overall time to prune which may
cause missed blocks and excessive resync time.

### Database Maintenance

The database is typically stable and can be left alone, although some attention
may be required:

```bash
# Check database size
du -sh ~/.sei/data/

# Confirm correct file paths as per your own setup before proceeding
# Before performing a database wipe, ensure you back up essential files:
# - `node_key.json`: Preserves node identity to maintain peer connections.
# - `priv_validator_key.json`: Critical for validators; losing this key results in double signing risks.
# - `config.toml` & `app.toml`: Retains node-specific configuration.
# - `genesis.json`: Required for correct chain initialization.

# Compact database to optimize storage (only if needed)
find ~/.sei/data/ -mindepth 1 ! -name 'priv_validator_state.json' -delete && rm -rf ~/.sei/wasm


# Backup database
cp -r ~/.sei/data/ ~/sei-backup-$(date +%Y%m%d)/
```

## Service Management

### Systemd Commands

```bash
# Check service status
systemctl status seid

# Start service
systemctl start seid

# Stop service
systemctl stop seid

# Restart service
systemctl restart seid

# View logs in real time
journalctl -fu seid -o cat
```

### Log Management

Prevent logs from consuming excessive disk space by enabling rotation:

```bash
sudo tee /etc/logrotate.d/sei > /dev/null << EOF
/var/log/sei/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 sei sei
    sharedscripts
    postrotate
        systemctl reload seid
    endscript
}
EOF
```

## Update Procedures

### Minor Updates

For minor updates that are non-consensus-breaking:

```bash
# Stop node
sudo systemctl stop seid

# Update binary
cd sei-chain
git fetch --all
git checkout [new-version]
make install

# Restart node
sudo systemctl restart seid
```

### Major Updates

For major upgrades that introduce state-breaking changes:

1. Wait for the designated upgrade block height [this can be seen in the upgrade
   proposal under 'plan']
2. The node will halt automatically.
3. Update/replace the binary
4. Restart the node.

```bash
# After node halts
cd sei-chain
git pull
git checkout [new-version]
make install
sudo systemctl restart seid
```

_Tip - build the upgrade before the halt-height so you can quickly replace it
with minimal downtime_

## Performance Optimization

Performance optimizations can yield different results depending on your system's
hardware, workload, and network conditions. Before implementing any changes,
research and test them in a controlled environment to ensure they align with
your specific configuration and requirements. Always back up important data
before making modifications.

### Memory Management (sysctl tuning)

Optimizing memory management settings can help improve performance and
stability, particularly for high-load nodes. These settings control swap usage
and the handling of dirty (unwritten) pages in RAM.

```bash
vm.swappiness = 1  # Reduce swapping to disk, ensuring RAM is used efficiently before relying on slower swap space
vm.dirty_background_ratio = 3  # The percentage of system memory that can be filled with "dirty" pages before background writing begins
vm.dirty_ratio = 10  # The maximum percentage of system memory that can be filled with "dirty" pages before a full flush is triggered
vm.dirty_expire_centisecs = 300  # Time (in hundredths of a second) before dirty data is written to disk
vm.dirty_writeback_centisecs = 100  # Frequency (in hundredths of a second) at which the system writes "dirty" pages to disk
```

### Network Stack Optimization

Tuning the network stack can enhance packet processing efficiency and
throughput, particularly for nodes handling a large number of peers and high
transaction volume.

```bash
net.core.somaxconn = 32768  # max connections in queued
net.core.netdev_max_backlog = 32768  # packets allowed in queue before dropping incoming packets
net.ipv4.tcp_max_syn_backlog = 16384  # outstanding SYN requests (half-open connections) allowed before dropping new connections
net.core.rmem_max = 16777216  # receive buffer size for network sockets
net.core.wmem_max = 16777216  # send buffer size for network sockets
```

### Storage Optimization

Optimizing storage settings can significantly reduce write latency and improve
database performance, especially for nodes using NVMe SSDs.

```bash
echo "none" > /sys/block/nvme0n1/queue/scheduler  # disable I/O scheduler to reduce latency
blockdev --setra 4096 /dev/nvme0n1  # readahead value to optimize sequential reads
```

## Backup and Recovery

### Regular Backups

Automate backups to avoid data loss:

```bash
#!/bin/bash
BACKUP_DIR="/backup/sei"
DATE=$(date +%Y%m%d)

# Stop service
systemctl stop seid

# Create backup
tar czf $BACKUP_DIR/sei-backup-$DATE.tar.gz ~/.sei/

# Restart service
systemctl start seid
```

### Recovery Procedure

Restoring from backup in case of corruption or accidental deletion:

```bash
# Stop node
systemctl stop seid

# Remove corrupted data
rm -rf ~/.sei/data/

# Restore from backup
tar xzf sei-backup-[date].tar.gz -C /

# Restart node
systemctl start seid
```

## Troubleshooting

### Common Issues and Fixes

1. **Sync Problems**

   - Check available disk space (`df -h`)
   - Ensure proper peer connections (`seid net info`)
   - Verify firewall settings (port 26656 open)

2. **Performance Issues**

   - Monitor system resources (`htop` or `iotop`)
   - Check disk I/O performance (`iostat`)
   - Analyze network traffic (`iftop`)

3. **Database Issues**

   - Run database integrity checks using:

     ```bash
     seid debug dump-db | grep -i error
     ```

     If errors are detected, consider restoring from a recent backup.

   - Consider pruning excessive historical data by adjusting `ss-keep-recent` in
     `app.toml` or running:

     ```bash
     seid unsafe-reset-all --home=$HOME/.sei --keep-addr-book
     ```

     Alternatively, manually remove old state snapshots to free up space:

     ```bash
     rm -rf ~/.sei/data/snapshots/*
     ```

### Diagnostic Commands

```bash
# Check sync status
seid status | jq .SyncInfo

# View peer count
seid net info | jq '.n_peers'

# Check validator status
seid query staking validator $(seid keys show -a $VALIDATOR_KEY)

# View recent blocks
seid query blocks recent
```

## Security Considerations

- Use firewalls and rate-limiting to prevent attacks
- Keep your system and node software updated
- Secure SSH access with key-based authentication
- Protect validator keys with offline storage or hardware security modules
  (HSMs)

For more in-depth system and configuration guidelines, refer to the _[Advanced
Configuration and Monitoring Guide]_(./advanced-config-monitoring).
